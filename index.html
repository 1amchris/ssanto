<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script>
        
        const net = require('net');

        console.log(net)
        
        class Client
        {
            constructor()
            {
                this.host = '127.0.0.1';
                this.port = 6969;
            
                this.messageListeners = new Map();
            
                this.client = new net.Socket();
                
                this.client.on('data', (data) => {
                    
                    var obj = JSON.parse(data);
                    console.log('Received: ' + data);
                    console.log(obj);
                    
                    if ('sid' in obj)
                    {
                        var f = this.messageListeners.get(obj.sid);
                        f(obj.data);
                    }
                });

                this.client.on('close', () => {
                    console.log('Connection closed');
                });
            }
            
            open()
            {
                this.client.connect(this.port, this.host, () => {
	                console.log('Connected');
                });
            }
            
            /*send(varName)
            {
                this.client.write('get ' + varName);
                return new Promise((resolve, reject) => {
                    this.client.once('data', (data) => {
                        var obj = JSON.parse(data);
                        resolve(obj.data);
                    });
                });
            }*/
            
            subscribe(sid, callable)
            {
                var obj = {
                    cmd: 'subscribe',
                    sid: sid
                };
                this.messageListeners.set(sid, callable);
                
                this.client.write(JSON.stringify(obj)+'\0');
            }
            
            callf(name)
            {
                var obj = {
                    cmd: 'callf',
                    trg: name
                };
                this.client.write(JSON.stringify(obj)+'\0');
            }
            
            callm(inst, meth)
            {
                var obj = {
                    cmd: 'callm',
                    instance: inst,
                    method: meth
                };
                this.client.write(JSON.stringify(obj)+'\0');
            }
            
            sendFile(file)
            {
                var obj = {
                    cmd: 'file',
                    data: file
                };
                this.client.write(JSON.stringify(obj)+'\0');
            }
            
            // TODO: Handle call that return
        };

        
        
        
        c = new Client();
       
        
        /*class DataProxy{
            constructor(varName) {
                this.varName = varName
            }
            get data() {
                return new Promise((resolve, reject) => {
                    c.send(this.varName).then( (data) => {
                        resolve(data)
                    });
                });
            }
            set data(value){}  };
        setTimeout(() => {
            d = new DataProxy("myVar");
            c.open();
            (async ()=>{
                console.log(await d.data);
            })();
        }, 1000);*/
        
        setTimeout(() => {
            
            c.open();
            
            c.subscribe('myVar', (data) => {
                console.log("`myVar` value is " + data);
            });
            
            c.callf('function');
            c.callm('a_class', 'method')
            
             
            
        }, 1000);
        
        function input(e) {
            let reader = new FileReader();
            reader.onload = (f) => {
                c.sendFile(f.target.result);
            };
            reader.readAsText(e.files[0]);
        }
    
    </script>
  </head>
  <body>
    <h1>Electron X Python</h1>
    Check console for the python output.
    
    <input type="file" onchange="input(this)"></input>
  </body>
</html>
